import file_tools
from circle_finding_tools import is_circle_in_center_of_images
import time
import numpy as np
import matplotlib.pyplot as plt

if __name__ == '__main__':
    image_number = 90
    profiles_range = False # (2000, 2100)
    h_min, h_max, v_min, v_max = 105, 364, 90, 349
    # h_min, h_max, v_min, v_max = 0, 483, 0, 360
    final_color_resolution = 63

    with file_tools.get_run(run_number=4) as current_run:
        beam_profiles = file_tools \
            .get_beam_profiles_pipeline(current_run=current_run, clip_to_profiles=profiles_range) \
            .slice_horizontally(h_min=h_min, h_max=h_max) \
            .slice_vertically(v_min=v_min, v_max=v_max) \
            .remove_background(number_of_lowest_colors=5, masking_color_resolution=15) \
            .opening() \
            .rescale_images(horizontal_scale=1.2) \
            .shift_to_center_of_mass() \
            .change_color_resolution(new_resolution=final_color_resolution) \
            .get_rounded_beam_profiles()

        beam_profiles_raw = file_tools \
            .get_beam_profiles_pipeline(current_run=current_run, clip_to_profiles=profiles_range) \
            .slice_horizontally(h_min=h_min, h_max=h_max) \
            .slice_vertically(v_min=v_min, v_max=v_max) \
            .change_color_resolution(new_resolution=4095) \
            .get_rounded_beam_profiles()

        plt.imshow(beam_profiles[image_number, :, :], cmap=plt.cm.jet)
        plt.show()
        plt.imshow(beam_profiles_raw[image_number, :, :], cmap=plt.cm.jet)
        plt.show()
        print(beam_profiles.shape)
        t = time.time()
        labels, circularity_indices = is_circle_in_center_of_images(beam_profiles, ring_thickness=10, number_of_tests=2,
                                                                    relative_tolerance=1e-3,
                                                                    additive_tolerance=1e-3)
        print(np.where(labels))
        print(len(np.where(labels)[0]))
        print(labels.shape)
        smallest_indices = np.argsort(circularity_indices)[:100]
        print(smallest_indices)
        print(circularity_indices[smallest_indices])
    print('elapsed:', time.time() - t)

# TEST
# labels = is_circle_in_center_of_images(beam_profiles, ring_thickness=10, number_of_tests=2,
#                                                relative_tolerance=1e-2,
#                                                additive_tolerance=1e-3)
# (array([   3,    5,   14,   15,   19,   20,   27,   33,   39,   43,   44,
#          58,   66,   69,   90,  106,  110,  123,  139,  146,  172,  182,
#         197,  204,  207,  211,  221,  222,  227,  232,  243,  246,  248,
#         251,  256,  267,  271,  274,  275,  280,  281,  290,  295,  297,
#         301,  302,  308,  317,  324,  329,  331,  340,  344,  353,  362,
#         367,  369,  372,  377,  389,  391,  398,  400,  403,  416,  417,
#         420,  448,  452,  455,  456,  461,  463,  473,  476,  486,  487,
#         503,  513,  522,  525,  528,  529,  540,  547,  559,  560,  561,
#         570,  572,  573,  574,  584,  593,  597,  599,  601,  602,  604,
#         605,  616,  617,  618,  621,  622,  628,  629,  632,  635,  636,
#         644,  671,  677,  698,  747,  751,  754,  759,  761,  768,  769,
#         770,  782,  789,  793,  799,  805,  826,  833,  839,  848,  877,
#         889,  907,  908,  943,  971,  980,  990,  992,  993, 1016, 1070,
#        1080, 1081, 1092, 1096, 1097, 1100, 1107, 1110, 1126, 1129, 1145,
#        1156, 1165, 1167, 1173, 1182, 1187, 1188, 1189, 1194, 1201, 1204,
#        1210, 1211, 1221, 1231, 1236, 1277, 1339, 1348, 1351, 1376, 1381,
#        1393, 1416, 1436, 1445, 1475, 1505, 1522, 1528, 1533, 1544, 1550,
#        1558, 1560, 1561, 1564, 1566, 1572, 1592, 1605, 1627, 1637, 1647,
#        1649, 1656, 1657, 1660, 1668, 1670, 1674, 1675, 1683, 1706, 1716,
#        1730, 1738, 1747, 1751, 1764, 1771, 1781, 1803, 1816, 1820, 1823,
#        1825, 1842, 1856, 1864, 1865, 1875, 1883, 1887, 1908, 1921, 1922,
#        1925, 1932, 1944, 1955, 1971, 1986, 2003, 2021, 2052, 2057, 2061,
#        2074, 2078, 2082, 2096, 2116, 2133, 2137, 2193, 2208, 2219, 2232,
#        2241, 2250, 2259, 2267, 2269, 2273, 2276, 2283, 2312, 2318, 2343,
#        2358, 2363, 2364, 2391, 2410, 2423, 2461, 2464, 2477, 2482, 2487,
#        2493, 2500, 2522, 2547, 2552, 2569, 2573, 2576, 2586, 2589, 2608,
#        2615, 2628, 2629, 2640, 2669, 2682, 2687, 2689, 2698, 2708, 2713,
#        2714, 2729, 2753, 2755, 2779, 2790, 2797, 2803, 2819, 2827, 2839,
#        2847, 2851, 2861, 2868, 2869, 2885, 2891, 2902, 2929, 2932, 2976,
#        3004, 3007, 3018, 3035, 3087, 3123, 3162, 3171, 3175, 3181, 3183,
#        3190, 3192, 3194, 3228, 3248, 3254, 3270, 3317, 3328, 3329, 3349,
#        3372, 3383, 3388, 3404, 3410, 3411, 3420, 3441, 3446, 3458, 3469,
#        3476, 3493, 3505, 3517, 3530, 3531, 3568, 3571, 3581, 3582, 3593,
#        3594, 3597, 3606, 3619, 3632, 3642, 3643, 3648, 3675, 3681, 3692,
#        3703, 3704, 3708, 3714, 3717, 3718, 3720, 3741, 3750, 3751, 3755,
#        3764, 3773, 3784, 3790, 3794, 3806, 3807, 3811, 3815, 3816, 3845,
#        3847, 3859, 3870, 3871, 3874, 3876, 3881, 3883, 3886, 3896, 3903,
#        3916, 3942, 3945, 3953, 3987, 3995, 3997, 4011, 4025, 4029, 4048,
#        4049, 4062, 4083, 4086, 4087, 4092, 4106, 4109, 4122, 4132, 4146,
#        4152, 4156, 4163, 4176, 4190, 4207, 4213, 4223, 4224, 4232, 4234,
#        4240, 4259, 4292, 4293, 4341, 4361, 4385, 4404, 4425, 4426, 4452,
#        4458, 4459, 4460, 4482, 4484, 4491, 4504, 4508, 4514, 4522, 4523,
#        4526, 4530, 4566, 4567, 4572, 4574, 4581, 4589, 4594, 4602, 4613,
#        4625, 4632, 4638, 4643, 4673, 4678, 4681, 4684, 4687, 4690, 4697,
#        4708, 4715, 4751, 4765, 4776, 4790, 4792, 4810, 4819, 4850, 4851,
#        4852, 4853, 4863, 4876, 4877, 4885, 4953, 4962, 4970, 4983, 4996,
#        4998, 5006, 5014, 5024, 5044, 5078, 5080, 5086, 5091, 5092, 5098,
#        5107, 5124, 5134, 5145, 5147, 5156, 5158, 5195, 5198, 5215, 5216,
#        5222, 5227, 5257, 5258, 5262, 5275, 5279, 5291, 5296, 5313, 5315,
#        5317, 5321, 5335, 5336, 5337, 5344, 5346, 5357, 5358, 5365, 5379,
#        5388, 5400, 5451, 5466, 5498, 5515, 5528, 5530, 5537, 5542, 5545,
#        5550, 5552, 5558, 5562, 5567, 5576, 5577, 5585, 5588, 5589, 5590,
#        5594, 5595, 5626, 5646, 5653, 5654, 5659, 5673, 5676, 5700, 5706,
#        5716, 5720, 5721, 5725, 5730, 5732, 5738, 5753, 5765, 5773, 5777,
#        5788, 5789, 5807, 5827, 5837, 5838, 5846, 5848, 5856, 5858, 5861,
#        5869, 5870, 5880, 5881, 5891, 5933, 5941, 5969, 5994, 6005, 6013,
#        6023, 6024, 6028, 6037, 6043, 6057, 6070, 6074, 6079, 6086, 6091,
#        6139, 6141, 6155, 6162, 6163, 6171, 6176, 6189, 6190, 6191, 6205,
#        6209, 6212, 6216, 6227, 6230, 6247, 6252, 6265, 6279, 6296, 6305,
#        6332, 6346, 6368, 6392, 6394, 6417, 6420, 6424, 6425, 6426, 6437,
#        6446, 6470, 6473, 6507, 6519, 6520, 6521, 6528, 6536, 6539, 6553,
#        6562, 6567, 6574, 6583, 6589, 6611, 6687, 6689, 6701, 6702, 6708,
#        6714, 6723, 6725, 6730, 6771, 6777, 6790, 6801, 6802, 6804, 6813,
#        6827, 6828, 6830, 6834, 6838, 6847, 6849, 6856, 6863, 6875, 6907,
#        6917, 6920, 6928, 6934, 6937, 6942, 6945, 6954, 6961, 6969, 7009,
#        7010, 7020, 7044, 7050, 7105, 7137, 7167, 7175, 7182, 7189, 7194,
#        7196, 7200, 7216, 7224, 7230, 7232, 7241, 7243, 7246, 7248, 7261,
#        7279, 7295, 7296, 7304, 7315, 7320, 7327, 7331, 7343, 7371, 7395,
#        7400, 7405, 7408, 7410, 7444, 7446, 7486, 7501, 7503, 7522, 7525,
#        7535, 7573, 7575, 7582, 7585, 7604, 7607, 7615, 7624, 7645, 7649,
#        7653, 7654, 7669, 7679, 7685, 7686, 7715, 7716, 7730, 7731, 7743,
#        7746, 7751, 7754, 7761, 7767, 7784, 7800, 7810, 7811, 7814, 7836,
#        7843, 7862, 7887, 7891, 7904, 7907, 7916, 7918, 7920, 7929, 7931,
#        7943, 7957, 7965, 7966, 7970, 7973, 7995, 8000, 8001, 8007, 8014,
#        8015, 8031, 8051, 8075, 8083, 8093, 8102, 8106, 8109, 8111, 8112,
#        8116, 8126, 8137, 8142, 8148, 8157, 8200, 8214, 8226, 8235, 8239,
#        8245, 8259, 8263, 8266, 8272, 8274, 8283, 8285, 8302, 8312, 8314,
#        8317, 8319, 8332, 8335, 8342, 8354, 8355, 8358, 8383, 8386, 8391,
#        8400, 8406, 8408, 8414, 8430, 8439, 8441, 8444, 8453, 8455, 8465,
#        8467, 8476, 8488, 8490, 8509, 8511, 8517, 8523, 8527, 8529, 8531,
#        8533, 8551, 8559, 8573, 8594, 8599, 8610, 8623, 8631, 8642, 8652,
#        8656, 8661, 8664, 8666, 8684, 8691, 8694, 8696, 8703, 8714, 8718,
#        8723, 8736, 8747, 8748, 8762, 8768, 8785, 8806, 8822, 8838, 8843,
#        8849, 8873, 8892, 8893, 8895, 8900, 8907, 8913, 8928, 8937, 8946,
#        8961, 8977, 8997, 8998, 9005, 9009, 9015, 9017, 9023, 9027, 9029,
#        9042, 9047, 9053, 9063, 9071, 9090, 9097, 9114, 9115]),)

# Circularity indeces - best 100, run 3
# [0.00022564 0.00023002 0.00036762 0.00036762 0.00039633 0.00039633
#  0.00041438 0.00042021 0.00044913 0.00077508 0.00079694 0.00086892
#  0.0008918  0.00095063 0.00095524 0.00098886 0.00101005 0.00106759
#  0.0010689  0.00107799 0.00108438 0.00109768 0.00111204 0.0011203
#  0.0011213  0.0011252  0.0011378  0.0011759  0.00119299 0.00122005
#  0.00123648 0.00124581 0.00129703 0.00131868 0.00131917 0.00132468
#  0.00135391 0.001372   0.00138895 0.00141555 0.00145925 0.00147454
#  0.00148333 0.00151073 0.0015727  0.00158386 0.00158879 0.00159434
#  0.00161435 0.00161559 0.00163312 0.00165183 0.00167128 0.00167716
#  0.00169337 0.00169819 0.00171613 0.00173444 0.00178318 0.00179788
#  0.00179872 0.00179902 0.00181194 0.00182727 0.0018359  0.00185273
#  0.00189903 0.0019025  0.00193575 0.00195062 0.00202482 0.00204771
#  0.00206036 0.00206077 0.00206245 0.00206695 0.00208379 0.00209731
#  0.00210311 0.00211379 0.00211471 0.00213521 0.00214801 0.00215148
#  0.00215712 0.00216532 0.00216671 0.0022335  0.00224184 0.00226077
#  0.00226244 0.0022651  0.00227042 0.00227187 0.00228172 0.00231792
#  0.00232518 0.00233487 0.0023408  0.00235118]
# [  90 5777 7970   58 1908  768 1194 3708 4224 5537 7331 3784 8226 2698
#  6520 7649 1204 7585  971 4146  593 1544  525  246 4514 5706 1533  560
#  7010 8465 5646 3987 8895 5092  353 6954 3571 5006 7050 8386 5346 6611
#   799 6247 1211 5725 1381 4086 5400  398 1110 8075 8703 6567 5147 9090
#  4850 8736 4482 6519 5358 6790 2552 7943 2615 2976 8383 5838 7582 8332
#  8961  992  271 3714 7405 5044 7522 5773 7731 1561 5024 4852   15 5837
#  8400 7904  529  267 3087 3741 5753 6425  698 5365 8873 5788 4996 6189
#  6155 1376]